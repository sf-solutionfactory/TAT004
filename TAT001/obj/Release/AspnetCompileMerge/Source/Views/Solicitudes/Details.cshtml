@model TAT001.Models.DocumentoFlujo
@using TAT001.Entities
@{
    /**/

    //ViewBag.Title = "Páginas";
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.pagina_r = 201;
    ViewBag.carpeta_r = 200;
}
@try
{
    <div class="row" style="margin-bottom:0">
        <div class="col s12 m5 l5">
            <div class="row" style="margin-bottom:0">
                <div class="input-field col s4">
                    @Html.EditorFor(model => model.D.USUARIOC_ID, new { htmlAttributes = new { @disabled = "disabled" } })
                    @Html.LabelFor(model => model.D.USUARIOC_ID, new { @id = "lbl_userid" })
                </div>
                <div class="input-field col s4">
                    @*<input type="text" id="txt_user" value="@ViewBag.usuario.MANAGER" disabled="disabled" />
                        <label for="txt_user">Manager</label>*@
                    @Html.EditorFor(model => model.D.USUARIO.MANAGER, new { htmlAttributes = new { @disabled = "disabled" } })
                    @Html.LabelFor(model => model.D.USUARIO.MANAGER, new { @id = "lbl_manager" })
                </div>
                <div class="input-field col s4">
                    @Html.EditorFor(model => model.D.USUARIO.BACKUP_ID, new { htmlAttributes = new { @disabled = "disabled" } })
                    @Html.LabelFor(model => model.D.USUARIO.BACKUP_ID, new { @id = "lbl_backup" })
                    @*<input type="text" id="txt_user" value="@ViewBag.usuario.BACKUP_ID" disabled="disabled" />
                        <label for="txt_user">Backup</label>*@
                </div>
            </div>
        </div>
        <div class="col s12 m2 l2">
            <div class="input-field col s6">
                @*<input type="text" id="txt_user" value="PRGA" disabled="disabled" />
                    <label for="txt_user">BU</label>*@
                @Html.EditorFor(model => model.D.USUARIO.BUNIT, new { htmlAttributes = new { @disabled = "disabled" } })
                @Html.LabelFor(model => model.D.USUARIO.BUNIT, "Sociedad", new { @id = "lbl_bu" })
            </div>
            <div class="input-field col s6">
                @if (Model.D.ESTATUS == "N")
                {
                    <input type="text" id="txt_status" value="Nuevo" disabled="disabled" />
                    <label for="txt_status" id="lbl_status">Estatus</label>
                }
            </div>
        </div>
        <div class="col s12 m5 l5">
            <div class="row right">
                @if (Model.D.ESTATUS_C != "C")
                {
                    if (ViewBag.acciones != null)
                    {
                        if (ViewBag.accion == "A" | ViewBag.accion == "R")
                        {
                            @*<button type="button" class="btn-small  " id="btn_workf">Acciones</button>*@
                            <div class="fixed-action-btn" id="lbl_wf">
                                <a class="btn-floating btn-large blue">
                                    <i class="large material-icons">work</i>
                                </a>
                                <ul>
                                    <li><a id="lbl_wfa" class="btn-floating green modal-trigger" href="#modal1" onclick="aprobar()"><i class="material-icons">check</i></a></li>
                                    <li><a id="lbl_wfr" class="btn-floating red modal-trigger" href="#modal1" onclick="rechazar()"><i class="material-icons">close</i></a></li>
                                </ul>
                            </div>
                            <script>

                                var elem = document.querySelector('.fixed-action-btn');
                                var options = {
                                    direction: 'left',
                                    hoverEnabled: false,
                                    toolbarEnabled: false
                                };
                                var instance = M.FloatingActionButton.init(elem, options);
                            </script>
                            @*<a id="lbl_wfa" class="btn-small  " href="@Url.Action("Procesa", "Flujos" , new { id=Model.D.NUM_DOC, accion="A" })">Aprobar</a>
                                <a id="lbl_wfr" class="btn-small  " href="@Url.Action("Procesa", "Flujos" , new { id=Model.D.NUM_DOC, accion="R" })">Rechazar</a>*@
                            <a class="btn-small modal-trigger" href="#modal1" onclick="aprobar()">Aprobar</a>
                            <a class="btn-small modal-trigger" href="#modal1" onclick="rechazar()">Rechazar</a>
                        }
                        else if (ViewBag.accion == "N")
                        {
                            <div class="fixed-action-btn" id="lbl_wf">
                                <a class="btn-floating btn-large blue">
                                    <i class="large material-icons">work</i>
                                </a>
                                <ul>
                                    <li><a id="lbl_wfn" class="btn-floating yellow darken-1 modal-trigger" href="#modal1" onclick="siguiente()"><i class="material-icons">play_arrow</i></a></li>
                                </ul>
                            </div>
                            <script>

                                var elem = document.querySelector('.fixed-action-btn');
                                var options = {
                                    direction: 'left',
                                    hoverEnabled: false,
                                    toolbarEnabled: false
                                };
                                var instance = M.FloatingActionButton.init(elem, options);
                            </script>
                            @*<a id="lbl_wfn" class="btn-small  " href="@Url.Action("Procesa", "Flujos" , new { id=Model.D.NUM_DOC, accion="N" })">Siguiente</a>*@
                            <a id="lbl_wfn" class="btn-small modal-trigger" href="#modal1" onclick="siguiente()">Siguiente</a>
                        }
                        else if (ViewBag.accion == "P")
                        {

                            <div class="fixed-action-btn" id="lbl_wf">
                                <a class="btn-floating btn-large blue">
                                    <i class="large material-icons">work</i>
                                </a>
                                <ul>
                                    <li><a id="lbl_wfn" class="btn-floating yellow darken-1 modal-trigger" href="#modal1" onclick="contabilizar()"><i class="material-icons">send</i></a></li>
                                </ul>
                            </div>
                            <script>

                                var elem = document.querySelector('.fixed-action-btn');
                                var options = {
                                    direction: 'left',
                                    hoverEnabled: false,
                                    toolbarEnabled: false
                                };
                                var instance = M.FloatingActionButton.init(elem, options);
                            </script>
                            @*<a id="lbl_wfn" class="btn-small  " href="@Url.Action("Procesa", "Flujos" , new { id=Model.D.NUM_DOC, accion="N" })">Siguiente</a>*@
                            <a id="lbl_wfn" class="btn-small modal-trigger" href="#modal1" onclick="contabilizar()">Contabilizar</a>
                        }
                        else if (!Model.D.ESTATUS.Equals("A"))
                        {
                            if (Model.D.USUARIOC_ID == ViewBag.usuario.ID)
                            {
                                <a class="btn-small modal-trigger" id="btn_cancel" href="#modal2">Cancelar</a>
                                <div id="modal2" class="modal">
                                    <div class="modal-content">
                                        <div class="row">
                                            <h4 id="txt_can">Cancelar solicitud</h4>
                                            <br />
                                        </div>
                                        <div class="row" style="">
                                            <div class="col s12 m12 l12">
                                                <div class="row" style="margin-bottom:0">
                                                    ¿Está seguro de cancelar esta solicitud?
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer right">
                                        <a href="#!" class="modal-action modal-close btn-flat">No</a>
                                        <a class="modal-action btn-flat" href="@Url.Action("Cancelar", "Solicitudes", new { id = Model.D.NUM_DOC })">Si</a>
                                    </div>
                                </div>
                            }
                        }
                    }
                    else if (Model.D.ESTATUS.Equals("A") && (Model.D.TSOL.PADRE))
                    {
                        if (Model.D.USUARIOC_ID == ViewBag.usuario.ID)
                        {
                            <a href="@Url.Action("Create", "Solicitudes", new { id_d = Model.D.NUM_DOC.ToString(), tsol = "CPR" })" class="btn-small">Reversar</a>
                            <button type="button" class="btn-small  " data-target="list_rela" id="btn_rela">Crear solicitud relacionada</button>
                            @*<button type="button" class="btn-small  " id="btn_cancel">Cancelar</button>*@
                            <ul id='list_rela' class='dropdown-content'>
                                <li><a href="@Url.Action("Create", "Solicitudes", new { id_d = Model.D.NUM_DOC.ToString(), tsol = "NC" })" id="lbl_nc">Nota de crédito</a></li>
                                <li><a href="@Url.Action("Create", "Solicitudes", new { id_d = Model.D.NUM_DOC.ToString(), tsol = "NCI" })" id="lbl_nc">Nota de crédito Int</a></li>
                                <li><a href="@Url.Action("Create", "Solicitudes", new { id_d = Model.D.NUM_DOC.ToString(), tsol = "OP" })" id="lbl_op">Orden de pago</a></li>
                            </ul>
                            <script>
                                var elem = document.getElementById('btn_rela');
                                var options = {
                                    hover: true
                                };
                                var instance = M.Dropdown.init(elem, options);
                            </script>
                        }
                    }
                    else if (!Model.D.ESTATUS.Equals("A"))
                    {
                        if (Model.D.USUARIOC_ID == ViewBag.usuario.ID)
                        {
                            <a class="btn-small modal-trigger" id="btn_cancel" href="#modal2">Cancelar</a>
                            <div id="modal2" class="modal">
                                <div class="modal-content">
                                    <div class="row">
                                        <h4 id="txt_can">Cancelar solicitud</h4>
                                        <br />
                                    </div>
                                    <div class="row" style="">
                                        <div class="col s12 m12 l12">
                                            <div class="row" style="margin-bottom:0">
                                                ¿Está seguro de cancelar esta solicitud?
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer right">
                                    <a href="#!" class="modal-action modal-close btn-flat">No</a>
                                    <a class="modal-action btn-flat" href="@Url.Action("Cancelar", "Solicitudes", new { id = Model.D.NUM_DOC })">Si</a>
                                </div>
                            </div>
                        }
                    }
                    @*//else
                        //{*@
                    <button type="button" class="btn-small  " data-target="list_carta" id="btn_carta">Carta</button>
                    @*<button type="button" class="btn-small  " id="btn_cancel">Cancelar</button>*@
                    <ul id='list_carta' class='dropdown-content'>
                        <li><a href="@Url.Action("Index", "CartaF" , new { id=Model.D.NUM_DOC })" id="lbl_list">Lista de cartas</a></li>
                        @if (Model.D.DOCUMENTOPs.Count().Equals(0))
                        {
                            <li><a href="@Url.Action("Create", "CartaF" , new { id=Model.D.NUM_DOC })" id="lbl_genc">Generar carta</a></li>
                        }
                        else
                        {
                            <li><a href="@Url.Action("Create", "CartaV" , new { id=Model.D.NUM_DOC })" id="lbl_genc">Generar carta</a></li>
                        }
                    </ul>
                    <script>
                        var elem = document.getElementById('btn_carta');
                        var options = {
                            constrainWidth: false
                            //,hover: true
                        };
                        var instance = M.Dropdown.init(elem, options);
                    </script>
                    @* } *@
                }
            </div>
        </div>
    </div>

    <div class="">
        <div class="row">
            <div class="col s12">
                <ul class="tabs tabs-fixed-width tab-demo " id="tab">
                    <li class="tab col s2"><a href="#info" id="lbl_info">Información</a></li>
                    <li class="tab col s2"><a href="#temp" id="lbl_temp">Temporalidad</a></li>
                    @if (ViewBag.acciones != null & ViewBag.accion == "S")
                    {
                        <li class="tab col s2"><a href="#supp" id="lbl_supp" class="active">Soporte</a></li>
                    }
                    else
                    {
                        <li class="tab col s2"><a href="#supp" id="lbl_supp">Soporte</a></li>
                    }
                    <li class="tab col s2"><a href="#dist" id="lbl_dist">Distribución</a></li>
                    @if (ViewBag.acciones != null & ViewBag.accion == "T")
                    {
                        <li class="tab col s2"><a href="#fina" id="lbl_fina" class="active">Financiera</a></li>
                    }
                    else
                    {
                        <li class="tab col s2"><a href="#fina" id="lbl_fina">Financiera</a></li>
                    }
                </ul>
            </div>
            <div id="info" class="col s12" style="font-size:12px;">
                <div class="row">
                    <div class="col s12 m6 l6">
                        @if (Model.D.DOCUMENTO_REF != null)
                        {
                            <div class="card-panel">
                                <div class="row" style="margin-bottom:0">
                                    <div class="input-field col s8">
                                        <input type="text" value="@Model.D.DOCUMENTO_REF" disabled="disabled" />
                                        @Html.LabelFor(model => model.D.DOCUMENTO_REF, "Provisión")
                                    </div>
                                    <div class="col s4 right-align">
                                        <a href="@Url.Action("Details", new { id=Model.D.DOCUMENTO_REF })" class="btn-small  ">Ver</a>
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="card-panel">
                            <div class="row" style="margin-bottom:0">
                                <div class="input-field col s12">
                                    @Html.EditorFor(model => model.D.TSOL.TSOLTs.Where(a => a.SPRAS_ID.Equals(model.D.USUARIO.SPRAS_ID)).FirstOrDefault().TXT020, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.TSOL, "Tipo de solicitud", new { @id = "lbl_tsol" })
                                </div>
                                <div class="input-field col s12">
                                    @Html.EditorFor(model => model.D.GALL.GALLTs.Where(a => a.SPRAS_ID.Equals(model.D.USUARIO.SPRAS_ID)).FirstOrDefault().TXT50, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.GALL_ID, "Clasificación", new { @id = "lbl_gall" })
                                </div>
                                @Html.HiddenFor(model => model.D.GALL_ID, new { @id = "gall_id" })
                                @Html.HiddenFor(model => model.D.TALL_ID, new { @id = "tall_id" })
                                @Html.HiddenFor(model => model.D.MONTO_DOC_MD, new { @id = "monto_dis" })
                            </div>
                        </div>
                        <div class="card-panel">
                            <h5>Datos país</h5>
                            <div class="row" style="margin-bottom:0">
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.SOCIEDAD_ID, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.SOCIEDAD, "Sociedad", new { @id = "lbl_bukrs" })
                                </div>
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.PAIS_ID, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.PAIS_ID, "País", new { @id = "lbl_land" })
                                </div>
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.ESTADO, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.ESTADO, "Estado", new { @id = "lbl_state" })
                                </div>
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.CIUDAD, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.CIUDAD, "Ciudad", new { @id = "lbl_city" })
                                </div>
                            </div>
                        </div>
                        @if (Model.D.DOCUMENTOF != null)
                        {
                            if (Model.D.DOCUMENTOF.Count > 0)
                            {
                                <div class="card-panel">
                                    <h5>Facturas</h5>
                                    <div class="row" style="margin-bottom:0">
                                        <div class="col s12">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        @if (Model.D.DOCUMENTOF[0].FACTURA != "0")
                                                        {
                                                            <th>Factura</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].FECHA != null)
                                                        {
                                                            <th>Fecha</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].PROVEEDOR != "0         ")
                                                        {
                                                            <th>Proveedor</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].CONTROL != "0")
                                                        {
                                                            <th>Control</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].AUTORIZACION != "0")
                                                        {
                                                            <th>Autorización</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].VENCIMIENTO != null)
                                                        {
                                                            <th>Vencimiento</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].FACTURAK != "0")
                                                        {
                                                            <th>Factura k</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].EJERCICIOK != "0")
                                                        {
                                                            <th>Ejercicio</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].BILL_DOC != "0         ")
                                                        {
                                                            <th>No fat</th>
                                                        }
                                                        @if (Model.D.DOCUMENTOF[0].BELNR != "0         ")
                                                        {
                                                            <th>No documento</th>
                                                        }
                                                    </tr>
                                                </thead>
                                                @foreach (var item in Model.D.DOCUMENTOF)
                                                {
                                                    <tr>
                                                        @if (item.FACTURA != "0")
                                                        {
                                                            <td>@item.FACTURA</td>
                                                        }
                                                        @if (item.FECHA != null)
                                                        {
                                                            <td>@item.FECHA</td>
                                                        }
                                                        @if (item.PROVEEDOR != "0         ")
                                                        {
                                                            <td>@item.PROVEEDOR</td>
                                                        }
                                                        @if (item.CONTROL != "0")
                                                        {
                                                            <td>@item.CONTROL</td>
                                                        }
                                                        @if (item.AUTORIZACION != "0")
                                                        {
                                                            <td>@item.AUTORIZACION</td>
                                                        }
                                                        @if (item.VENCIMIENTO != null)
                                                        {
                                                            <td>@item.VENCIMIENTO</td>
                                                        }
                                                        @if (item.FACTURAK != "0")
                                                        {
                                                            <td>@item.FACTURAK</td>
                                                        }
                                                        @if (item.EJERCICIOK != "0")
                                                        {
                                                            <td>@item.EJERCICIOK</td>
                                                        }
                                                        @if (item.BILL_DOC != "0         ")
                                                        {
                                                            <td>@item.BILL_DOC</td>
                                                        }
                                                        @if (item.BELNR != "0         ")
                                                        {
                                                            <td>@item.BELNR</td>
                                                        }
                                                    </tr>
                                                }
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                    <div class="col s12 m6 l6">
                        <div class="row" style="margin-bottom:0">
                            <div class="card-panel">
                                <div class="row" style="margin-bottom:0">
                                    <h5>Información general</h5>
                                    <div class="input-field col s12">
                                        @Html.EditorFor(model => model.D.FECHAC, new { htmlAttributes = new { @disabled = "disabled", @type = "text" } })
                                        @Html.LabelFor(model => model.D.FECHAC, "Fecha", new { @id = "lbl_fechac" })
                                    </div>
                                    <div class="input-field col s6 l6">
                                        @Html.EditorFor(model => model.D.PERIODO, new { htmlAttributes = new { @disabled = "disabled", @type = "text" } })
                                        @Html.LabelFor(model => model.D.PERIODO, "Periodo", new { @id = "lbl_periodo" })
                                    </div>
                                    <div class="input-field col s6">
                                        @Html.EditorFor(model => model.D.EJERCICIO, new { htmlAttributes = new { @disabled = "disabled", @type = "text" } })
                                        @Html.LabelFor(model => model.D.EJERCICIO, "Ejercicio", new { @id = "lbl_ejer" })
                                    </div>
                                    <div class="input-field col s12">
                                        @Html.EditorFor(model => model.D.CONCEPTO, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.CONCEPTO, "Concepto", new { @id = "lbl_conce" })
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row" style="margin-bottom:0">
                            <div class="card-panel">
                                <h5>@*@Html.DisplayFor(model => model.D.CLIENTE.KUNNR)*@</h5>
                                <div class="row" style="margin-bottom:0">
                                    <div class="input-field col s12">
                                        @Html.EditorFor(model => model.D.CLIENTE.KUNNR, new { htmlAttributes = new { @disabled = "disabled", @id = "payer_id" } })
                                        @Html.LabelFor(model => model.D.CLIENTE.KUNNR)
                                    </div>
                                    <div class="input-field col s12">
                                        @Html.EditorFor(model => model.D.CLIENTE.NAME1, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.CLIENTE.NAME1, "Nombre", new { @id = "lbl_name" })
                                    </div>
                                    <div class="input-field col s12">
                                        @Html.EditorFor(model => model.D.CLIENTE.STCD1, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.CLIENTE.STCD1, "Taxid", new { @id = "lbl_stcd1" })
                                    </div>
                                    <div class="input-field col s12">
                                        @Html.EditorFor(model => model.D.CLIENTE.CANAL, new { htmlAttributes = new { @disabled = "disabled", @id = "vtweg" } })
                                        @Html.LabelFor(model => model.D.CLIENTE.CANAL, "Canal", new { @id = "lbl_stcd1" })
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="temp" class="col s12">
                <div class="row">
                    <div class="col s12 m12 l12">
                        <div class="card-panel">
                            <div class="row" style="margin-bottom:0">
                                <h5>Vigencia</h5>
                                @*<div class="input-field col s12">
                                        @Html.EditorFor(model => model.D.NUM_DOC, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.NUM_DOC)
                                    </div>*@
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.FECHAI_VIG, new { htmlAttributes = new { @disabled = "disabled", @type = "text" } })
                                    @Html.LabelFor(model => model.D.FECHAI_VIG, "De", new { @id = "lbl_fechai" })
                                </div>
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.FECHAF_VIG, new { htmlAttributes = new { @disabled = "disabled", @type = "text" } })
                                    @Html.LabelFor(model => model.D.FECHAF_VIG, "A", new { @id = "lbl_fechaf" })
                                </div>
                            </div>
                        </div>
                    </div>

                    @if (Model.D.DOCUMENTORECs.Count() > 0)
                    {
                        <div class="col s12 m12 l12" style="font-size:12px;">
                            <div class="card-panel">
                                <div class="row">
                                    <h5>Recurrencia</h5>
                                </div>
                                <div class="row">
                                    <div class="col s12">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Pos</th>
                                                    <th>Tipo</th>
                                                    <th>Documento</th>
                                                    <th>Fecha</th>
                                                    <th>Monto</th>
                                                    <th>%</th>
                                                    <th>Aplicado</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var iteem in Model.D.DOCUMENTORECs)
                                                {
                                                    <tr>
                                                        <td>@iteem.POS</td>
                                                        <td>@Model.D.TSOL.TSOLTs.Where(a => a.SPRAS_ID.Equals(Session["spras"].ToString())).FirstOrDefault().TXT50</td>
                                                        @if (iteem.DOC_REF > 0)
                                                        {
                                                            <td><a href="@Url.Action("Details", new { id = iteem.DOC_REF })">@iteem.DOC_REF</a></td>
                                                        }
                                                        else
                                                        {
                                                            <td></td>
                                                        }
                                                        <td>@iteem.FECHAF.Value.ToShortDateString()</td>
                                                        <td>@iteem.MONTO_BASE</td>
                                                        <td>@Math.Round(iteem.PORC.Value, 2)</td>
                                                        @if (iteem.ESTATUS == "P")
                                                        {
                                                            <td><i class="material-icons">check</i></td>
                                                        }
                                                        else
                                                        {
                                                            <td><i class="material-icons">close</i></td>
                                                        }
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div id="supp" class="col s12">
                @{
                    List<TAT001.Entities.DOCUMENTOA>
                        archivos = ViewBag.files as List<TAT001.Entities.DOCUMENTOA>
                            ;
                    string[] nombrefile;
                }
                <div class="row">
                    <div class="col s12 m12 l6">
                        <div class="card-panel">
                            <div class="row">
                                <h5>Soportes</h5>
                            </div>
                            <div class="row">
                                @using (Html.BeginForm("Descargar", "Solicitudes", FormMethod.Post))
                                {
                                    try
                                    {
                                        for (int i = 0; i < archivos.Count; i++)
                                        {
                                            nombrefile = archivos[i].PATH.Split('\\');
                                            <div class="file-field input-field">
                                                <button id="lbl_cargar" name="archivo" class="btn" type="submit" value="@archivos[i].PATH">DESCARGAR</button>
                                                <div class="file-path-wrapper">
                                                    <input disabled value="@nombrefile[nombrefile.Length - 1]" id="disabled" type="text" class="file-path validate">
                                                </div>
                                            </div>
                                        }
                                    }
                                    catch (Exception)
                                    {
                                    }
                                }
                            </div>
                        </div>
                    </div>
                    @if (ViewBag.acciones != null)
                    {
                        if (ViewBag.accion == "S")
                        {
                            <div class="col s12 m12 l6">
                                <div class="card-panel">
                                    <div class="row">
                                        <h5>Carta</h5>
                                    </div>
                                    <div class="row">


                                        @using (Html.BeginForm("Details", "Solicitudes", FormMethod.Post, new { enctype = "multipart/form-data" }))
                                        {
                                            @Html.AntiForgeryToken()
                                            @Html.HiddenFor(model => model.D.NUM_DOC)
                                            @*<label>Carta</label><label class"lbl_nec">*</label>*@
                                            <label name="labels_soporte2">Acuerdo comercial</label><label class"lbl_nec"></label>
                                            <input type="text" value="Carta" name="labels_soporte" hidden />
                                            <div class="file-field input-field">
                                                <div class="btn-small  " style="float:left;">
                                                    <span>Examinar</span>
                                                    @*<input class="file_soporte nec" name="files_soporte" id="file_carta" type="file">*@
                                                    <input class="file_soporte" name="files_soporte" id="file_carta" type="file">
                                                </div>
                                                <div class="file-path-wrapper">
                                                    <input class="file-path validate" type="text">
                                                </div>
                                            </div>
                                            <div class="col s12 right-align">
                                                <input type="submit" value="Enviar" class="btn-small  " />
                                            </div>}
                                    </div>
                                </div>
                            </div>

                        }
                    }
                    @if (Model.D.DOCUMENTORs.Count() > 0)
                    {
                        <div class="col s12 m12 l6">
                            <div class="card-panel">
                                <div class="row">
                                    <h5>Reversa</h5>
                                </div>
                                <div class="row">
                                    @foreach (var iteem in Model.D.DOCUMENTORs)
                                    {
                                        <div class="input-field col s12">
                                            <input id="txt_trev" type="text" disabled="disabled" value="@iteem.TREVERSA.TREVERSATs.Where(a => a.SPRAS_ID.Equals(Session["spras"].ToString())).FirstOrDefault().TXT100" />
                                            <label for="txt_trev">Tipo de reversa</label>
                                        </div>
                                        <div class="input-field col s12">
                                            <textarea id="txt_comm" disabled="disabled" class="materialize-textarea">@iteem.COMENTARIO</textarea>
                                            <label for="txt_comm">Comentario</label>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
            <div id="dist" class="col s12">
                <div class="row">
                    <div class="card-panel">
                        <div class="row" style="margin-bottom:0">
                            <h5>Distribución</h5>
                            <div class="input-field col s12">
                                @if (Model.D.DOCUMENTOPs.Count > 0)
                                {
                                    <table style="font-size: 12px;">
                                        <thead>
                                            <tr>
                                                <th>Vigencia de</th>
                                                <th>Vigencia a</th>
                                                @if (Model.D.DOCUMENTOPs.First().MATNR != "")
                                                {
                                                    <th>Material</th>
                                                }
                                                else
                                                {
                                                    <th>Categoría</th>
                                                }
                                                <th>Descripción</th>
                                                <th>Precio unitario</th>
                                                <th>% apoyo</th>
                                                <th>Apoyo por pieza</th>
                                                <th>Precio sugerido</th>
                                                @if (Model.D.TSOL.FACTURA == false)
                                                {
                                                    <th>Volumen estimado</th>
                                                    <th>Estimado apoyo</th>
                                                }
                                                else
                                                {
                                                    <th>Volumen real</th>
                                                    <th>Apoyo real</th>
                                                }
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var item in Model.D.DOCUMENTOPs.Where(a => a.VIGENCIA_DE != null & (a.MATNR != "" | a.MATKL != null)))
                                            {
                                                <tr id="pos-@item.POS" onclick="muestra(this.id)">
                                                    <td>
                                                        @try
                                                        {@item.VIGENCIA_DE.Value.ToShortDateString()}
                                                    catch { }
                                                    </td>
                                                    <td>
                                                        @try
                                                        {@item.VIGENCIA_AL.Value.ToShortDateString()}
                                                    catch { }
                                                    </td>
                                                    @if (item.MATNR != "")
                                                    {
                                                        <td>@item.MATNR.TrimStart('0')</td>
                                                    }
                                                    else
                                                    {
                                                        <td>@item.MATKL</td>
                                                    }
                                                    @{
                                                        using (TAT001.Entities.TAT001Entities db = new TAT001.Entities.TAT001Entities())
                                                        {
                                                            if (item.MATNR != "")
                                                            {
                                                                var matnr = db.MATERIALs.Find(item.MATNR);
                                                                if (matnr != null)
                                                                {
                                                                    <td>@matnr.MAKTX</td>}
                                                                else
                                                                {
                                                                    <td></td>
                                                                }
                                                            }
                                                            else
                                                            {
                                                                var matkl = db.MATERIALGPs.Find(item.MATKL);
                                                                if (matkl != null)
                                                                {
                                                                    <td>@matkl.MATERIALGPTs.Where(a => a.SPRAS_ID.Equals(Session["spras"].ToString())).FirstOrDefault().TXT50 </td>}
                                                                else
                                                                {
                                                                    <td></td>
                                                                }
                                                            }

                                                        }
                                                    }
                                                    <td>@Math.Round(item.MONTO, 2)</td>
                                                    <td>@Math.Round(item.PORC_APOYO, 2)</td>
                                                    <td>@Math.Round(item.MONTO_APOYO, 2)</td>
                                                    <td>@Math.Round(item.PRECIO_SUG, 2)</td>

                                                    @if (Model.D.TSOL.FACTURA == false)
                                                    {
                                                        <td>@Math.Round(item.VOLUMEN_EST, 2)</td>
                                                        <td>@Math.Round((decimal)item.APOYO_EST, 2)</td>
                                                    }
                                                    else
                                                    {
                                                        <td>@Math.Round((decimal)item.VOLUMEN_REAL, 2)</td>
                                                        <td>@Math.Round(((decimal)item.APOYO_REAL), 2)</td>
                                                    }
                                                </tr>
                                                foreach (var mat in item.DOCUMENTOMs)
                                                {
                                                    <tr class="mat-@mat.POS_ID" style="display:none;">
                                                        <td></td>
                                                        <td></td>
                                                        <td>@mat.MATNR.TrimStart('0')</td>
                                                        @{
                                                            using (TAT001.Entities.TAT001Entities db = new TAT001.Entities.TAT001Entities())
                                                            {
                                                                if (mat.MATNR != "")
                                                                {
                                                                    var matnr = db.MATERIALs.Find(mat.MATNR);
                                                                    if (matnr != null)
                                                                    {
                                                                        <td>@matnr.MAKTX</td>}
                                                                    else
                                                                    {
                                                                        <td></td>
                                                                    }
                                                                }
                                                            }
                                                        }

                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                        <td></td>
                                                        @if (Model.D.TSOL.FACTURA == false)
                                                        {
                                                            <td>@Math.Round((decimal)mat.APOYO_EST, 2)</td>
                                                        }
                                                        else
                                                        {
                                                            <td>
                                                                @Math.Round((decimal)mat.APOYO_REAL, 2)
                                                            </td>
                                                        }
                                                    </tr>

                                                }
                                            }
                                        </tbody>
                                    </table>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <script>
                    function muestra(id) {
                        var ii = id.split('-')[1];
                        var clas = $("#" + id).hasClass("m");
                        if (!clas) {
                            var a = document.getElementsByClassName("mat-" + ii);
                            var i;
                            for (i = 0; i < a.length; i++) {
                                a[i].style.display = "table-row";
                            }
                            document.getElementById("pos-" + ii).classList.add("m");
                        }
                        else {
                            var a = document.getElementsByClassName("mat-" + ii);
                            var i;
                            for (i = 0; i < a.length; i++) {
                                a[i].style.display = "none";
                            }
                            document.getElementById("pos-" + ii).classList.remove("m");
                        }

                    }
                </script>
            </div>
            <div id="fina" class="col s12">
                <div class="row">
                    @if (ViewBag.acciones != null)
                    {
                        if (ViewBag.accion == "T")
                        {
                            <div class="col s12 m12 l12">
                                @using (Html.BeginForm("Taxeo", "Solicitudes"))
                                {
                                    @Html.AntiForgeryToken()
                                    @Html.HiddenFor(model => model.D.NUM_DOC)
                                    <div class="card-panel">
                                        <h5>Taxeo</h5>
                                        <div class="row">
                                            <div class="col s12 m12 l12">
                                                <div class="row" id="lbl_taxeo">
                                                    <div class="input-field col s6 m6 l3">
                                                        <select id="txt_concepto" name="txt_concepto" onchange="selConcepto(this.value)">
                                                            <option value=""></option>
                                                        </select>
                                                        <label for="txt_concepto">Concepto</label>
                                                    </div>
                                                    <div class="input-field col s6 m6 l3">
                                                        <input id="txt_nota" name="txt_nota" disabled="disabled" />
                                                        <label id="lbl_nota" for="txt_nota">Tipo de nota</label>
                                                    </div>
                                                    <div class="col s12 m12 l6">
                                                        <div>
                                                            <table class="table" id="tab_conc">
                                                                <thead>
                                                                    <tr>
                                                                        <th>Concepto</th>
                                                                        <th>Porcenaje</th>
                                                                        <th>Código</th>
                                                                        <th>Totales</th>
                                                                    </tr>
                                                                <thead>
                                                                <tbody></tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                </div>
                                                <script>
                                            taxeo("txt_concepto");

                                            function taxeo(id)
                                            {
                                                var campo = document.getElementById(id);
                                                $("#" + id).find('option').remove();
                                                //$("#lbl_puestos").empty();
                                                ///1

                                                var soci = '@Model.D.SOCIEDAD_ID';
                                                var pais = '@Model.D.PAIS_ID';
                                                var vkorg = '@Model.D.VKORG';
                                                var vtweg = '@Model.D.VTWEG';
                                                var spart = '@Model.D.SPART';
                                                var kunnr = '@Model.D.PAYER_ID';
                                                var spras = '@Session["spras"].ToString()';
                                                $.ajax({
                                                    url: "../../Listas/selectTaxeo",
                                                    type: "GET",
                                                    async: false,
                                                    timeout: 30000,
                                                    dataType: "json",
                                                    data: { bukrs: soci, pais: pais, vkorg: vkorg, vtweg: vtweg, spart: spart, kunnr: kunnr, spras: spras },
                                                    success: function(data) {
                                                        var pp = ($.map(data, function(item) {
                                                            return { label: item.TXT50, value: item.CONCEPTO_ID };
                                                        }))
                                                        $("#" + id)
                                                            .append($("<option></option>")
                                                                .attr("value", "")
                                                                .text(""));
                                                        for (var i = 0; i < pp.length; i++)
                                                        {
                                                            //var div =  "<option value='" + pp[i].value + "'>" + pp[i].label + "</option>"
                                                            //$("#txt_pai").append(div);
                                                            $("#" + id)
                                                                .append($("<option></option>")
                                                                    .attr("value", pp[i].value)
                                                                    .text(pp[i].label));
                                                        }
                                                        var el = document.getElementById(id);
                                                        var instances = M.Select.init(el, []);
                                                    }
                                                });
                                            }

                                            function selConcepto(value)
                                            {
                                                //2
                                                //$("#lbl_puestos").empty();
                                                var soci = '@Model.D.SOCIEDAD_ID';
                                                var pais = '@Model.D.PAIS_ID';
                                                var vkorg = '@Model.D.VKORG';
                                                var vtweg = '@Model.D.VTWEG';
                                                var spart = '@Model.D.SPART';
                                                var kunnr = '@Model.D.PAYER_ID';
                                                var concepto_id = value;
                                                var spras = '@Session["spras"].ToString()';
                                                $.ajax({
                                                    url: "../../Listas/selectConcepto",
                                                    type: "POST",
                                                    async: false,
                                                    timeout: 30000,
                                                    dataType: "json",
                                                    data: { bukrs: soci, pais: pais, vkorg: vkorg, vtweg: vtweg, spart: spart, kunnr: kunnr, concepto: concepto_id, spras: spras },
                                                    success: function(data) {
                                                        var pp = ($.map(data, function(item) {
                                                            return { label: item.TXT50, value: item.CONCEPTO_ID };
                                                        }))
                                                        if (pp.length > 0)
                                                        {
                                                            $("#txt_nota").val(pp[0].label);
                                                            $("#lbl_nota").addClass("active");
                                                        }
                                                        else
                                                        {
                                                            $("#txt_nota").val("");
                                                            $("#lbl_nota").removeClass("active");
                                                        }
                                                    }
                                                });
                                                $.ajax({
                                                    url: "../../Listas/selectImpuesto",
                                                    type: "POST",
                                                    async: false,
                                                    timeout: 30000,
                                                    dataType: "json",
                                                    data: { bukrs: soci, pais: pais, vkorg: vkorg, vtweg: vtweg, spart: spart, kunnr: kunnr, concepto: concepto_id, spras: spras },
                                                    success: function(data) {
                                                        $("#tab_conc tbody").empty();
                                                        var pp = ($.map(data, function (item) {
                                                            return { IMPUESTO_ID: item.IMPUESTO_ID, PORC: item.PORC, TEXT: item.TXT50 };
                                                        }))
                                                        for (var i = 0; i < pp.length; i++)
                                                        {
                                                            var cod = pp[i].IMPUESTO_ID;
                                                            var por = pp[i].PORC;
                                                            var tot = @Model.D.MONTO_DOC_ML;
                                                            var sub = tot * por / 100;

                                                            $("#tab_conc tbody").append("<tr><td>" + pp[i].TEXT + "</td><td>" + (por / 100) + "%</td><td>" + cod + "</td><td>" + sub + "</td><tr>");
                                                        }
                                                    }
                                                });
                                            }
                                                </script>
                                            </div>
                                            <div class="col s12 right-align">
                                                <input type="submit" class="btn" value="Enviar" />
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    }
                    <div class="col s12 m6 l6">
                        <div class="card-panel">
                            <h5>Detalle de solicitud</h5>
                            <div class="row" style="margin-bottom:0">
                                <div class="input-field col s8">
                                    @if (ViewBag.accion == "N")
                                    {
                                        @Html.EditorFor(model => model.D.MONTO_DOC_MD)
                                    }
                                    @Html.EditorFor(model => model.D.MONTO_DOC_MD, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.MONTO_DOC_MD, "Monto", new { @id = "lbl_montomd" })
                                </div>
                                <div class="input-field col s4">
                                    @Html.EditorFor(model => model.D.MONEDA_ID, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.MONEDA_ID, "Moneda", new { @id = "lbl_waers" })
                                </div>
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.TIPO_CAMBIO, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.TIPO_CAMBIO, "Tipo de cambio", new { @id = "lbl_tcambio" })
                                </div>
                                <div class="input-field col s6">
                                    @Html.EditorFor(model => model.D.MONTO_DOC_ML2, new { htmlAttributes = new { @disabled = "disabled" } })
                                    @Html.LabelFor(model => model.D.MONTO_DOC_ML2, "Monto USD", new { @id = "lbl_montoml2" })
                                </div>
                                @if (Model.D.TSOL_ID == "PR")
                                {
                                    <div class="input-field col s4">
                                        @Html.EditorFor(model => model.D.TSOL_ID, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.TSOL_ID, "Company code", new { @id = "lbl_montoml2" })
                                    </div>
                                    <div class="input-field col s4">
                                        @Html.EditorFor(model => model.D.DOCUMENTO_SAP, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.DOCUMENTO_SAP, "No. Docuemento SAP", new { @id = "lbl_montoml2" })
                                    </div>
                                    <div class="input-field col s4">
                                        @Html.EditorFor(model => model.D.SOCIEDAD_ID, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.SOCIEDAD_ID, "Company code", new { @id = "lbl_montoml2" })
                                    </div>
                                    <div class="input-field col s6">
                                        @Html.EditorFor(model => model.D.PERIODO, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.PERIODO, "Periodo", new { @id = "lbl_montoml2" })
                                    </div>
                                    <div class="input-field col s6">
                                        @Html.EditorFor(model => model.D.EJERCICIO, new { htmlAttributes = new { @disabled = "disabled" } })
                                        @Html.LabelFor(model => model.D.EJERCICIO, "Ejercicio", new { @id = "lbl_montoml2" })
                                    </div>
                                }
                                <div class="input-field col s12">
                                    @Html.TextAreaFor(model => model.D.NOTAS, new { @id = "txt_notas", @class = "materialize-textarea", @style = "height:500px;", @disabled = "disabled" })
                                    @Html.LabelFor(model => model.D.NOTAS, "Mecánica de negociación", new { @id = "lbl_notas" })
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col s12 m6 l6 right">
                        <!--RSG 22.05.2018-->
                        <div class="card-panel">
                            <div class="row">
                                <h5>Cuentas</h5>
                                <div class="col s12">
                                    <div id="div_clearing">
                                    </div>
                                </div>
                            </div>
                            <script>
                        var clearing = [];
                        function getClearing(gall)
                        {
                            $("#div_clearing").empty();
                            clearing = [];
                            /**/
                            var bukrs = '@Model.D.SOCIEDAD_ID';
                            /**/
                            /**/
                            var land = '@Model.D.PAIS_ID';
                            /**/
                            /**/
                            var ejercicio = '@Model.D.EJERCICIO';
                            /**/
                            $.ajax({
                                type: "POST",
                                url: '../../Listas/clearing',
                                dataType: "json",
                                data: { bukrs: bukrs, land: land, gall: gall, ejercicio: ejercicio },

                                success: function(data) {
                                    if (data !== null || data !== "")
                                    {
                                        //RSG 26.04.2018----------------
                                        clearing.push(data.ABONO);
                                        clearing.push(data.CARGO);
                                        clearing.push(data.CLEARING);
                                        clearing.push(data.LIMITE);
                                        //RSG 26.04.2018----------------
                                    }

                                },
                                error: function(xhr, httpStatusMessage, customErrorMessage) {
                                    M.toast({ html: httpStatusMessage });
                                },
                                async: false
                            });

                        }
                        function formaClearing()
                        {
                            getClearing(document.getElementById("tall_id").value);
                            $("#div_clearing").empty();
                            var monto = document.getElementById("monto_dis").value;
                            var div = "<ul class='collection'><li class='collection-item'>";
                            div += "<div class='row' style='margin-bottom:0;'><div class='col s4'>Abono</div><div class='col s4'>" + clearing[0] + "</div><div class='col s4 right-align'>$" + monto + "</div></div>";
                            div += "</li><li class='collection-item'>";

                            if (clearing[3] == null)
                            {
                                div += "<div class='row' style='margin-bottom:0;'><div class='col s4'>Cargo</div><div class='col s4'>" + clearing[1] + "</div><div class='col s4 right-align'>$" + monto + "</div></div>";
                            }
                            else
                            {
                                if (clearing[2] != null)
                                {
                                    if (monto <= clearing[3])
                                    {
                                        div += "<div class='row' style='margin-bottom:0;'><div class='col s4'>Cargo</div><div class='col s4'>" + clearing[1] + "</div><div class='col s4 right-align'>$" + monto + "</div></div>";
                                        div += "</li><li class='collection-item'>                                        ";
                                        div += "<div class='row' style='margin-bottom:0;'><div class='col s4'>Clearing</div><div class='col s4'>" + clearing[2] + "</div><div class='col s4 right-align'>$0.00</div></div>";
                                        div += "    </li>";
                                    }
                                    else
                                    {
                                        div += "  <div class='row' style='margin-bottom:0;'><div class='col s4'>Cargo</div><div class='col s4'>" + clearing[1] + "</div><div class='col s4 right-align'>$" + clearing[3] + "</div></div>";
                                        div += "</li><li class='collection-item'>                                     ";
                                        div += "<div class='row' style='margin-bottom:0;'><div class='col s4'>Clearing</div><div class='col s4'>" + clearing[2] + "</div><div class='col s4 right-align'>$" + (monto - clearing[3]) + "</div></div>";
                                        div += "          </li>";
                                    }
                                }
                            }
                            div += "</li>";
                            div += "       </ul>";
                            $("#div_clearing").append(div);
                        }
                            </script>
                        </div>

                        @using (TAT001Entities db = new TAT001Entities())
                        {
                            List<DOCUMENTO> inf = new List<DOCUMENTO>();
                            inf = db.DOCUMENTOes.Where(x => x.DOCUMENTO_REF == Model.D.NUM_DOC).ToList();
                            <div class="card-panel">
                                <div class="row">
                                    <h5>Relacionados</h5>
                                    <div class="col s12">
                                        @if (inf.Count() > 0)
                                        {
                                            <table class="table striped" id="table" style="width:100%; font-size:12px;">
                                                <thead>
                                                    <tr class="header">
                                                        <th>
                                                            @Html.LabelFor(model => model.D.TSOL_ID, "Tipo")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.NUM_DOC, "Documento")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.DOCUMENTO_SAP, "SAP")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.SOCIEDAD_ID, "Sociedad")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.PERIODO, "Periodo")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.EJERCICIO, "Ejercicio")
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (var miCi in inf)
                                                    {
                                                        <tr>
                                                            <td>
                                                                @miCi.TSOL_ID
                                                            </td>
                                                            <td>
                                                                @miCi.NUM_DOC
                                                            </td>
                                                            <td>
                                                                @miCi.DOCUMENTO_SAP
                                                            </td>
                                                            <td>
                                                                @miCi.SOCIEDAD_ID
                                                            </td>
                                                            <td>
                                                                @miCi.PERIODO
                                                            </td>
                                                            <td>
                                                                @miCi.EJERCICIO
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        }
                                        else
                                        {
                                            <table class="table striped" id="table" style="width:100%; font-size:12px;">
                                                <thead>
                                                    <tr class="header">
                                                        <th>
                                                            @Html.LabelFor(model => model.D.TSOL_ID, "Tipo")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.NUM_DOC, "Documento")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.DOCUMENTO_SAP, "SAP")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.SOCIEDAD_ID, "Sociedad")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.PERIODO, "Periodo")
                                                        </th>
                                                        <th>
                                                            @Html.LabelFor(model => model.D.EJERCICIO, "Ejercicio")
                                                        </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>
                                                            @Model.D.TSOL_ID
                                                        </td>
                                                        <td>
                                                            @Model.D.NUM_DOC
                                                        </td>
                                                        <td>
                                                            @Model.D.DOCUMENTO_SAP
                                                        </td>
                                                        <td>
                                                            @Model.D.SOCIEDAD_ID
                                                        </td>
                                                        <td>
                                                            @Model.D.PERIODO
                                                        </td>
                                                        <td>
                                                            @Model.D.EJERCICIO
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        }
                                    </div>
                                </div>
                            </div>
                        }

                        <div class="card-panel">
                            <h5>Análisis Presupuesto<p style="font-size:15px">Última fecha de carga @ViewBag.ultMod</p></h5>
                            <div class="row" style="margin-bottom:0">
                                <ul class="collection">
                                    <li class="collection-item">
                                        <div class="row" style="margin-bottom:0;">
                                            <div class="col s4">
                                                Presupuesto canal
                                            </div>
                                            <div class="col s4">
                                                <label id="p_vtweg">
                                                    aaaa
                                                </label>
                                            </div>
                                            <div class="col s4 right-align">
                                                <label id="p_canal">
                                                    1111
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="collection-item">
                                        <div class="row" style="margin-bottom:0;">
                                            <div class="col s4">
                                                Presupuesto cliente
                                            </div>
                                            <div class="col s4">
                                                <label id="p_kunnr">

                                                </label>
                                            </div>
                                            <div class="col s4 right-align">
                                                <label id="p_banner">
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                            <div class="row">
                                <ul class="collection">
                                    <li class="collection-item">
                                        <div class="row" style="margin-bottom:0;">
                                            <div class="col s6">
                                                Registrado en SAP
                                            </div>
                                            <div class="col s6 right-align">
                                                <label id="pc_c">
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="collection-item">
                                        <div class="row" style="margin-bottom:0;">
                                            <div class="col s6">
                                                Por registrar en SAP
                                            </div>
                                            <div class="col s6 right-align">
                                                <label id="pc_a">
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="collection-item">
                                        <div class="row" style="margin-bottom:0;">
                                            <div class="col s6">
                                                En proceso TAT
                                            </div>
                                            <div class="col s6 right-align">
                                                <label id="pc_p">
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="collection-item">
                                        <div class="row" style="margin-bottom:0;">
                                            <div class="col s6">
                                                Consumido
                                            </div>
                                            <div class="col s6 right-align">
                                                <label id="pc_t">
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                    <li class="collection-item">
                                        <div class="row" style="margin-bottom:0;">
                                            <div class="col s6">
                                                Presupuesto disponible
                                            </div>
                                            <div class="col s6 right-align">
                                                <label id="consu">
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                                @*</ul>*@
                            </div>
                        </div>
                    </div>
                    @if (Model.D.CONCEPTO_ID != null)
                    {<div class="col s12 m12 l12">
                            <div class="card-panel">
                                <h5>Taxeo</h5>
                                <div class="row">
                                    <div class="col s12 m12 l12">
                                        <div class="row" id="lbl_taxeo">
                                            <div class="input-field col s6 m6 l3">
                                                <input type="text" id="txt_concepto" name="txt_concepto" value="@Model.D.CONCEPTO_ID" disabled="disabled" />
                                                <label for="txt_concepto">Concepto</label>
                                            </div>
                                            <div class="input-field col s6 m6 l3">
                                                <input id="txt_nota" name="txt_nota" disabled="disabled" />
                                                <label id="lbl_nota" for="txt_nota">Tipo de nota</label>
                                            </div>
                                            <div class="col s12 m12 l6">
                                                <div>
                                                    <table class="table" id="tab_conc">
                                                        <thead>
                                                            <tr>
                                                                <th>Concepto</th>
                                                                <th>Porcenaje</th>
                                                                <th>Código</th>
                                                                <th>Totales</th>
                                                            </tr>
                                                        <thead>
                                                        <tbody></tbody>
                                                        <tfoot>
                                                        </tfoot>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        <script>
                                selConcepto(document.getElementById("txt_concepto").value);


                                function selConcepto(value)
                                {
                                    //3
                                    //$("#lbl_puestos").empty();
                                    var soci = '@Model.D.SOCIEDAD_ID';
                                    var pais = '@Model.D.PAIS_ID';
                                    var vkorg = '@Model.D.VKORG';
                                    var vtweg = '@Model.D.VTWEG';
                                    var spart = '@Model.D.SPART';
                                    var kunnr = '@Model.D.PAYER_ID';
                                    var concepto_id = value;
                                    var spras = '@Session["spras"].ToString()';
                                    $.ajax({
                                        url: "../../Listas/selectConcepto",
                                        type: "POST",
                                        async: false,
                                        timeout: 30000,
                                        dataType: "json",
                                        data: { bukrs: soci, pais: pais, vkorg: vkorg, vtweg: vtweg, spart: spart, kunnr: kunnr, concepto: concepto_id, spras: spras },
                                        success: function(data) {
                                            var pp = ($.map(data, function(item) {
                                                return { label: item.TXT50, value: item.CONCEPTO_ID };
                                            }))
                                            if (pp.length > 0)
                                            {
                                                $("#txt_nota").val(pp[0].label);
                                                $("#lbl_nota").addClass("active");
                                            }
                                            else
                                            {
                                                $("#txt_nota").val("");
                                                $("#lbl_nota").removeClass("active");
                                            }
                                        }
                                    });
                                    $.ajax({
                                        url: "../../Listas/selectImpuesto",
                                        type: "POST",
                                        async: false,
                                        timeout: 30000,
                                        dataType: "json",
                                        data: { bukrs: soci, pais: pais, vkorg: vkorg, vtweg: vtweg, spart: spart, kunnr: kunnr, concepto: concepto_id, spras: spras },
                                        success: function(data) {
                                            $("#tab_conc tbody").empty();
                                            var pp = ($.map(data, function(item) {
                                                return { IMPUESTO_ID: item.IMPUESTO_ID, PORC: item.PORC, label: item.TXT50 };
                                            }))
                                            var foot = @Model.D.MONTO_DOC_ML;
                                            for (var i = 0; i < pp.length; i++)
                                            {
                                                var cod = pp[i].IMPUESTO_ID;
                                                var por = pp[i].PORC;
                                                var tot = @Model.D.MONTO_DOC_ML;
                                                var sub = tot * por / 100;
                                                foot = foot + sub;

                                                $("#tab_conc tbody").append("<tr><td>" + pp[i].label + "</td><td>" + (por / 100) + "%</td><td>" + cod + "</td><td>" + sub + "</td><tr>");
                                            }

                                            $("#tab_conc tfoot").append("<tr><td></td><td></td><td></td><th>" + foot + "</th><tr>");
                                        }
                                    });
                                }
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>

                    }

                    @if (ViewBag.Relacionados != null)
                    {
                        if (ViewBag.Relacionados.Count > 0)
                        {

                            <div class="col s12 m6 l6">
                                <div class="card-panel">
                                    <h5>Relacionados</h5>
                                    <div class="row" style="margin-bottom:0">
                                        <div class="col s12">
                                            <table>
                                                <thead>
                                                    <tr>
                                                        <th>Documento</th>
                                                        <th>Tipo Solicitud</th>
                                                        @*<th>Fecha</th>
                                                            <th>Hora</th>*@
                                                        <th></th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @foreach (TAT001.Entities.DOCUMENTO item in ViewBag.Relacionados)
                                                    {
                                                        <tr>
                                                            <td>
                                                                @item.NUM_DOC
                                                            </td>
                                                            <td>
                                                                @item.TSOL.TSOLTs.Where(a => a.SPRAS_ID.Equals(Session["spras"].ToString())).FirstOrDefault().TXT50
                                                            </td>
                                                            @*<td>
                                                                    @item.FECHAC.Value.ToShortDateString()
                                                                </td>
                                                                <td>
                                                                    @item.HORAC.Value.ToString().Split('.')[0]
                                                                </td>*@
                                                            <td>
                                                                <a href="@Url.Action("Details", new { id = item.NUM_DOC })" class="btn-small">Ver</a>
                                                            </td>
                                                        </tr>
                                                    }
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>}
                    }
                </div>
            </div>
            @*<div id="dist" class="col s12">Test 4</div>*@
        </div>
        <script>
            var el = document.getElementById("tab");
            options = [];
            var instance = M.Tabs.init(el, options);
        </script>
    </div>
    if (ViewBag.acciones != null)
    {
        using (Html.BeginForm("Procesa", "Flujos"))
        {
            <div id="modal1" class="modal  bottom-sheet">
                @Html.AntiForgeryToken()
                <div class="modal-content">
                    <div class="row">
                        <h4 id="txt_app" style="display:none">Aprobar solicitud</h4>
                        <h4 id="txt_rec" style="display:none"> Rechazar solicitud</h4>
                        <h4 id="txt_nex" style="display:none"> Agregar comentario</h4>
                        <h4 id="txt_cont" style="display:none">
                            Contabilizar
                        </h4>

                        <br />

                    </div>

                    <div class="row" style="">
                        <div class="col s12 m12 l12">
                            <div class="row" style="margin-bottom:0">
                                @Html.HiddenFor(model => model.F.WORKF_ID)
                                @*@Html.LabelFor(model => model.F.WORKF_ID, new { @id = "lbl_userid" })*@
                                @Html.HiddenFor(model => model.F.WF_VERSION)
                                @*@Html.LabelFor(model => model.F.WF_VERSION, new { @id = "lbl_userid" })*@
                                @Html.HiddenFor(model => model.F.WF_POS)
                                @*@Html.LabelFor(model => model.F.WF_POS, new { @id = "lbl_userid" })*@
                                @Html.HiddenFor(model => model.F.NUM_DOC)
                                @*@Html.LabelFor(model => model.F.NUM_DOC, new { @id = "lbl_userid" })*@
                                @Html.HiddenFor(model => model.F.LOOP)
                                @*@Html.LabelFor(model => model.F.LOOP, new { @id = "lbl_userid" })*@
                                @Html.HiddenFor(model => model.F.ESTATUS, new { @id = "wf_estatus" })
                                @*@Html.LabelFor(model => model.F.ESTATUS, new { @id = "lbl_userid" })*@
                                <div class="input-field col s10 offset-s1">
                                    @Html.TextAreaFor(model => model.F.COMENTARIO, new { @class = "materialize-textarea", @id = "txt_comentario" })
                                    @Html.LabelFor(model => model.F.COMENTARIO, new { @id = "lbl_userid" })
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-fixed-footer right">
                    <a href="#!" class="modal-action modal-close btn-flat">Cancelar</a>
                    <input type="submit" value="Aceptar" class="modal-action modal-close btn-flat" onclick="document.getElementById('loader').style.display = 'initial';" />
                    @*<a class="btn-small btn-default" href="@Url.Action("Details", "Solicitudes" , new { id=Model.F.NUM_DOC})">Cancelar</a>*@
                </div>
            </div>
            if (ViewBag.accion == "R")
            {
                <div class="row" style="font-size:12px;">
                    <div class="col s12">
                        <div class="row" style="margin-bottom:0">
                            <div class="card-panel">
                                <div class="row">
                                    <h5>Trade Spending</h5>
                                </div>
                                <div class="row">
                                    <div class="col l4 m4 s12">
                                        @foreach (var item in ViewBag.ts)
                                        {
                                            <div class="col s12">
                                                <p style="margin-top:0;">
                                                    <label>
                                                        @foreach (var ii in item.TS_FORMT)
                                                        {
                                                            if (ii.SPRAS_ID == Session["spras"].ToString())
                                                            {
                                                                <input type="checkbox" id="chk-@ii.TSFORM_ID" name="chk-@ii.TSFORM_ID" />
                                                                <span>@ii.TXT100</span>
                                                            }
                                                        }
                                                    </label>
                                                </p>
                                            </div>
                                        }
                                    </div>
                                    @*<div class="col s8 right-align">
                                            <input type="submit" value="Calificar" class="btn-small  " />
                                        </div>*@
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            <script>

                var elem = document.getElementById('modal1');
                var instance = M.Modal.init(elem, []);
                var elem2 = document.getElementById('modal2');
                if (elem2 != undefined)
                    var instance2 = M.Modal.init(elem2, []);

                function aprobar() {
                    document.getElementById("txt_app").style.display = 'initial';
                    document.getElementById("txt_rec").style.display = 'none';
                    document.getElementById("txt_nex").style.display = 'none';
                    document.getElementById("txt_cont").style.display = 'none';
                    document.getElementById("txt_comentario").value = '';
                    document.getElementById("wf_estatus").value = 'A';
                }
                function rechazar() {
                    document.getElementById("txt_rec").style.display = 'initial';
                    document.getElementById("txt_app").style.display = 'none';
                    document.getElementById("txt_nex").style.display = 'none';
                    document.getElementById("txt_cont").style.display = 'none';
                    document.getElementById("txt_comentario").value = '';
                    document.getElementById("wf_estatus").value = 'R';
                }
                function siguiente() {
                    document.getElementById("txt_rec").style.display = 'none';
                    document.getElementById("txt_app").style.display = 'none';
                    document.getElementById("txt_nex").style.display = 'initial';
                    document.getElementById("txt_cont").style.display = 'none';
                    document.getElementById("txt_comentario").value = '';
                    document.getElementById("wf_estatus").value = 'A';
                }
                function contabilizar() {
                    document.getElementById("txt_rec").style.display = 'none';
                    document.getElementById("txt_app").style.display = 'none';
                    document.getElementById("txt_nex").style.display = 'none';
                    document.getElementById("txt_cont").style.display = 'initial';
                    document.getElementById("txt_comentario").value = '';
                    document.getElementById("wf_estatus").value = 'A';
                }
            </script>
        }
    }
    if (ViewBag.tts.Count != 0)
    {

        <div class="row" style="font-size:12px;">
            <div class="col s12">
                <div class="row" style="margin-bottom:0">
                    <div class="card-panel">
                        <div class="row">
                            <h5>Trade Spending</h5>
                        </div>
                        <div class="row">
                            <div class="col l4 m4 s12">
                                @foreach (var item in ViewBag.tts)
                                {
                                    <div class="col s12">
                                        <p style="margin-top:0;">
                                            <label>
                                                @foreach (var ii in item.TS_FORM.TS_FORMT)
                                                {
                                                    if (ii.SPRAS_ID == Session["spras"].ToString())
                                                    {
                                                        if (item.CHECKS)
                                                        {
                                                            <input type="checkbox" id="chk-@ii.TSFORM_ID" name="chk-@ii.TSFORM_ID" checked="checked" disabled="disabled" />
                                                        }
                                                        else
                                                        {
                                                            <input type="checkbox" id="chk-@ii.TSFORM_ID" name="chk-@ii.TSFORM_ID" disabled="disabled" />
                                                        }
                                                        <span>@ii.TXT100</span>
                                                    }
                                                }
                                            </label>
                                        </p>
                                    </div>
                                }
                            </div>
                            @*<div class="col s8 right-align">
                                    <input type="submit" value="Calificar" class="btn-small  " />
                                </div>*@
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
    if (ViewBag.workflow.Count != 0)
    {
        <div class="row" style="font-size:12px;">
            <div class="col s12">
                <div class="row" style="margin-bottom:0">
                    <div class="card-panel">
                        <h5>Workflow</h5>
                        @*
                            <script src="//code.jquery.com/jquery-1.12.4.js"></script>
                            <script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
                            <script src="//cdn.datatables.net/1.10.16/js/dataTables.material.min.js"></script>
                            <link href="~/Content/dataTable.css" rel="stylesheet" />
                            <link href="//cdn.datatables.net/1.10.16/css/dataTables.material.min.css" rel="stylesheet" />*@
                        <table class="table highlight responsive-table" id="table">
                            <thead>
                                <tr>
                                    <th width="">
                                        Usuario
                                    </th>
                                    <th width="">
                                        Evento
                                    </th>
                                    <th width=""> Fecha inicio</th>
                                    <th width=""> Hora inicio</th>
                                    <th width=""> Fecha término</th>
                                    <th width=""> Hora término</th>
                                    <th width="">
                                        Estatus
                                    </th>
                                    <th width="30%">
                                        Comentario
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (TAT001.Entities.FLUJO f in ViewBag.workflow)
                                {
                                    <tr>
                                        <td width=""> @Html.DisplayFor(modelItem => f.USUARIOA_ID) - @Html.DisplayFor(modelItem => f.USUARIO.NOMBRE) @Html.DisplayFor(modelItem => f.USUARIO.APELLIDO_P) @Html.DisplayFor(modelItem => f.USUARIO.APELLIDO_M) </td>

                                        <td width=""> @Html.DisplayFor(modelItem => f.WORKFP.ACCION.DESCCRIPCION) </td>

                                        <td width=""> @f.FECHAC.Value.ToShortDateString() </td>

                                        <td width=""> @f.FECHAC.Value.TimeOfDay.ToString().Split('.')[0] </td>

                                        <td width=""> @f.FECHAM.Value.ToShortDateString() </td>

                                        <td width=""> @f.FECHAM.Value.TimeOfDay.ToString().Split('.')[0] </td>

                                        <td width=""> @Html.DisplayFor(modelItem => f.ESTATUS) </td>

                                        <td width="30%"> @Html.DisplayFor(modelItem => f.COMENTARIO) </td>

                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

                                                                }
                                                            }
                                                            catch (Exception ee)
                                                            {
                                                                Session["error"] = ee.Message.ToString();
                                                                <script>
                                                                    document.location.replace("../../Home/Index");
                                                                </script>
                                                            }
<p>
    @Html.ActionLink("Edit", "Edit", new { id = Model.D.NUM_DOC }) |
    @Html.ActionLink("Back to List", "Index")
</p>
<script>
    var canal = $('#vtweg').val();
    var canal = canal.split('-');
    canal[0] = $.trim(canal[0]);
    $('#p_vtweg').text(canal[0]);
    //Obtener cliente id
    var kunnr = $('#payer_id').val();
    //$('#cli_name').val();
    $('#p_kunnr').text(kunnr);
    var aaa = document.getElementById("payer_id").value;
    asignarPresupuesto(aaa);

    function asignarPresupuesto(kunnr) {

        $.ajax({
            type: "POST",
            url: '../../Listas/getPresupuesto',
            dataType: "json",
            data: { "kunnr": kunnr },

            success: function (data) {

                if (data !== null || data !== "") {
                    //$('#p_canal').text(data.P_CANAL);
                    //$('#p_banner').text(data.P_BANNER);
                    //$('#pc_c').text(data.PC_C);
                    //$('#pc_a').text(data.PC_A);
                    //$('#pc_p').text(data.PC_P);
                    //$('#pc_t').text(data.PC_T);
                    //RSG 26.04.2018----------------
                    $('#p_canal').text('$' + ((data.P_CANAL / 1).toFixed(2)));
                    $('#p_banner').text('$' + ((data.P_BANNER / 1).toFixed(2)));
                    $('#pc_c').text('$' + ((data.PC_C / 1).toFixed(2)));
                    $('#pc_a').text('$' + ((data.PC_A / 1).toFixed(2)));
                    $('#pc_p').text('$' + ((data.PC_P / 1).toFixed(2)));
                    $('#pc_t').text('$' + ((data.PC_T / 1).toFixed(2)));
                    $('#consu').text('$' + ((data.CONSU / 1).toFixed(2)));
                    //RSG 26.04.2018----------------
                }

            },
            error: function (xhr, httpStatusMessage, customErrorMessage) {
                M.toast({ html: httpStatusMessage });
            },
            async: false
        });

    }

    formaClearing();
    //M.textareaAutoResize($('#txt_notas'));
</script>
@if (TempData["error"] != null)
{
    @*<div class="row red-text">
            @ViewBag.Error
        </div>*@

    if (TempData["error"].ToString() != "")
    {
        <script>
    /**/
    M.toast({ html: '@TempData["error"]', classes: '' });
/**/
        </script>
    }
}
