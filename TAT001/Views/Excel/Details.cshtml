@model TAT001.Entities.DOCUMENTO
@using TAT001.Entities

@{
    ViewBag.pagina_r = 221;
    ViewBag.carpeta_r = 200;
    //ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<script>
    var elem = document.querySelector('select');
    var options = [];
    //var instance = M.Select.init(elem, options);
</script>
<script src="//code.jquery.com/jquery-1.12.4.js"></script>
<script src="//cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
<script src="//cdn.datatables.net/1.10.16/js/dataTables.material.min.js"></script>
<link href="~/Content/dataTable.css" rel="stylesheet" />
<link href="//cdn.datatables.net/1.10.16/css/dataTables.material.min.css" rel="stylesheet" />


@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="row">
        <div class="row right">
            <div class="col l12 m12 right">
                <a data-form-method="post" href="@Url.Action("Details", "Excel", new { rutaExcel = ViewBag.ruta })" class="waves-effect waves-light btn">Guardar</a>
                @*<a data-form-method="post" href="@Url.Action("Details", "Excel", new { doc = p, a = "hola" })" class="waves-effect waves-light btn">Guardar</a>*@
                @*<input type="submit" value="Guardar" class="btn btn-default" />*@
            </div>
        </div>
    </div>

    <div class="row">
        <div class="row" style="height:10px;width:100%;">
            <div class="col l7 pink darken-1" style="height:10px;padding:0;"></div>
            <div class="col l3 pink darken-4" style="height:10px;padding:0;">
                <div class="col l3 pink darken-4" style="height:10px;padding:0;"></div>
                <div class="col l8 orange" style="height:10px;padding:0;"></div>
                <div class="col l1 red" style="height:10px;padding:0;"></div>
            </div>
            <div class="col l2 yellow" style="height:10px;padding:0;"></div>
        </div>
    </div>

    <table class="table mdl-data-table striped" id="table" style="width:100%;">
        <thead>
            <tr class="header" style="background-color:#CCCCCC">
                <th></th>
                <th>
                    @Html.DisplayNameFor(model => model.NUM_DOC)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.TSOL_ID)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.GALL_ID)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.SOCIEDAD_ID)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.PAIS_ID)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.ESTADO)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.CIUDAD)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.CONCEPTO)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.PUESTO_ID)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.PAYER_NOMBRE)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.PAYER_ID)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.FECHAD)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.FECHAC)
                </th>
                <th>
                    @Html.DisplayNameFor(model => model.MONEDA_ID)
                </th>
            </tr>
        </thead>
        @using (TAT001Entities db = new TAT001Entities())
        {
            <tbody>
                @for (int i = 1; i < ViewBag.data1.Tables[0].Rows.Count; i++)
                {
                    string a = ViewBag.data1.Tables[0].Rows[i][1].ToString();
                    string b = ViewBag.data1.Tables[0].Rows[i][2].ToString();
                    string c = ViewBag.data1.Tables[0].Rows[i][3].ToString();
                    string d = ViewBag.data1.Tables[0].Rows[i][4].ToString();
                    string k = ViewBag.data1.Tables[0].Rows[i][14].ToString();
                    var e = db.TSOLs.Where(x => x.ID == a).Select(x => x.ID);
                    var f = db.GALLs.Where(x => x.ID == b).Select(x => x.ID);
                    var g = db.SOCIEDADs.Where(x => x.BUKRS == c).Select(x => x.BUKRS);
                    var h = db.PAIS.Where(x => x.LAND == d).Select(x => x.LAND);
                    var kk = db.MONEDAs.Where(x => x.WAERS == k).Select(x => x.WAERS);

                    string dd = ViewBag.data1.Tables[0].Rows[i][9].ToString();
                    var ee = db.CLIENTEs.Where(x => x.KUNNR == dd);

                    var u = ViewBag.usuario;
                    string IdU = u.ID;

                    var per = from P in db.PAIS
                              join C in db.CREADOR2 on P.LAND equals C.LAND
                              where P.ACTIVO == true
                              & C.ID == IdU & C.ACTIVO == true
                              select P;

                    string mi1 = ViewBag.data1.Tables[0].Rows[i][3].ToString();
                    string mi2 = ViewBag.data1.Tables[0].Rows[i][4].ToString();
                    var perm = per.Where(x => x.SOCIEDAD_ID == mi1 & x.LAND == mi2).FirstOrDefault();

                    if (e.Count() > 0 && f.Count() > 0 && g.Count() > 0 && h.Count() > 0 & ee.Count() > 0 & kk.Count() > 0)
                    {
                        if (perm != null)
                        {
                            <tr>
                                <td class="details-control" style="cursor:pointer">
                                    <i class="material-icons">add</i>
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][0].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][1].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][2].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][3].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][4].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][5].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][6].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][7].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][9].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][10].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][11].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][12].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][13].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][14].ToString()
                                </td>
                            </tr>
                        }
                        else
                        {
                            <tr class="red white-text">
                                <td class="details-control" style="cursor:pointer">
                                    <i class="material-icons">add</i>
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][0].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][1].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][2].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][3].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][4].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][5].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][6].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][7].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][9].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][10].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][11].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][12].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][13].ToString()
                                </td>
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][14].ToString()
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td class="details-control" style="cursor:pointer">
                                <i class="material-icons">add</i>
                            </td>
                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][0].ToString()
                            </td>

                            @if (e.Count() > 0)
                            {
                                <td>@ViewBag.data1.Tables[0].Rows[i][1].ToString()</td>}
                            else
                            {
                                <td class="red white-text">@ViewBag.data1.Tables[0].Rows[i][1].ToString()</td>}

                            @if (f.Count() > 0)
                            {
                                <td>@ViewBag.data1.Tables[0].Rows[i][2].ToString()</td>}
                            else
                            {
                                <td class="red white-text">@ViewBag.data1.Tables[0].Rows[i][2].ToString()</td>}

                            @if (g.Count() > 0)
                            {
                                <td>@ViewBag.data1.Tables[0].Rows[i][3].ToString()</td>}
                            else
                            {
                                <td class="red white-text">@ViewBag.data1.Tables[0].Rows[i][3].ToString()</td>}

                            @if (h.Count() > 0)
                            {
                                <td>@ViewBag.data1.Tables[0].Rows[i][4].ToString()</td>}
                            else
                            {
                                <td class="red white-text">@ViewBag.data1.Tables[0].Rows[i][4].ToString()</td>}

                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][5].ToString()
                            </td>
                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][6].ToString()
                            </td>
                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][7].ToString()
                            </td>

                            @if (ee.Count() > 0)
                            {
                                <td>
                                    @ViewBag.data1.Tables[0].Rows[i][9].ToString()
                                </td>
                            }
                            else
                            {
                                <td class="red white-text">
                                    @ViewBag.data1.Tables[0].Rows[i][9].ToString()
                                </td>
                            }
                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][10].ToString()
                            </td>
                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][11].ToString()
                            </td>
                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][12].ToString()
                            </td>
                            <td>
                                @ViewBag.data1.Tables[0].Rows[i][13].ToString()
                            </td>
                            @if (kk.Count() > 0)
                            {
                                <td>@ViewBag.data1.Tables[0].Rows[i][14].ToString()</td>}
                            else
                            {
                                <td class="red white-text">@ViewBag.data1.Tables[0].Rows[i][14].ToString()</td>}
                        </tr>
                    }
                }
            </tbody>
        }
    </table>
}

<script type="text/javascript">
    $("a[data-form-method='post']").click(function (event) {
        event.preventDefault();
        var element = $(this);
        var action = element.attr("href");
        element.closest("form").each(function () {
            var form = $(this);
            form.attr("action", action);
            form.submit();
        });
    });
</script>

<script>
    $(document).ready(function () {
        var table = $('#table').DataTable({
            scrollX: "50vh",
            scrollY: "50vh",
            scrollCollapse: true,
            order: [[4, "desc"], [5, "desc"], [1, "desc"]],
            language: {
                "url": "../Scripts/lang/@Session["spras"].ToString()" + ".json"
            },
            columnDefs: [
                {
                    targets: [1, 2, 3, 4, 5, 6],
                    className: 'mdl-data-table__cell--non-numeric'
                }
            ],
            initComplete: function () {
                this.api().columns().every(function () {
                    var column = this;
                    var select = $('<select style="display:initial;" class="browser-default"><option value=""></option></select>')
                        .appendTo($(column.footer()).empty())
                        .on('change', function () {
                            var val = $.fn.dataTable.util.escapeRegex(
                                $(this).val()
                            )
                            ;

                            column
                                .search(val ? '^' + val + '$' : '', true, false)
                                .draw();
                        });

                    column.cells('', column[0]).render('display').sort().unique().each(function (d, j) {
                        var val = $('<div/>').html(d).text();
                        select.append('<option value="' + val + '">' + val + '</option>');
                    });
                });
            }
        });

        $('#selecc').on('change', function () {
            table.page.len(this.value).draw();
        });

        $('input.global_filter').on('keyup click', function () {
            filterGlobal();
        });

        $('#table tbody').on('click', 'td.details-control', function () {
            var tr = $(this).closest('tr');
            var row = table.row(tr);

            if (row.child.isShown()) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
            }
            else {
                // Open this row
                //row.child(format(row.data())).show();
                //tr.addClass('shown');
                // Open this row
                var child = format(row.data(), row, tr);
                if (child != undefined) {
                }
            }
        });

    });

    function filterGlobal() {
        $('#table').DataTable().search(
            $('#global_filter').val()).draw();
    }

    function convert(str) {
        var date = new Date(str),
            mnth = ("0" + (date.getMonth()+1)).slice(-2),
            day  = ("0" + date.getDate()).slice(-2);
        return [ day, mnth, date.getFullYear() ].join("/");
    }

    function format(d, row, tr) {
        $.ajax({
            url: "Doc",
            type: "GET",
            async: false,
            timeout: 30000,
            dataType: "json",
            data: { num_doc: d[1] },
            success: function (data) {
                var ldp = ($.map(data, function (item) {
                    return { label: item, value: item };
                }))
                var ret = "<table class='table mdl-data-table striped'>";
                for (var i = 0; i < data.length; i++) {
                    var date = data[i].VIGENCIA_DE.replace(/[^0-9 +]/g, '');
                    var fechaJS = new Date(parseInt(data[i].VIGENCIA_DE.replace(/[^0-9 +]/g, '')));
                    var fechaJS2 = new Date(parseInt(data[i].VIGENCIA_AL.replace(/[^0-9 +]/g, '')));

                    ret += "<tr ><td>" + data[i].NUM_DOC + "</td><td>" + data[i].POS + "</td>";
                    ret += data[i].MATNR;
                    ret += data[i].MATKL;

                    ret += "<td>" + data[i].MONTO + "</td>";
                    ret += "<td>" + data[i].PORC_APOYO + "</td>";
                    ret += "<td>" + data[i].PRECIO_SUG + "</td>";
                    ret += "<td>" + data[i].VOLUMEN_EST + "</td>";
                    ret += "<td>" + data[i].APOYO_EST + "</td>";

                    if (fechaJS > fechaJS2) {
                        var dd = convert(fechaJS);
                        var dd2 = convert(fechaJS2);
                        ret += "<td class='red white-text'>" + dd + "</td>";
                        ret += "<td class='red white-text'>" + dd2 + "</td>";
                    }
                    else {
                        var dd = convert(fechaJS);
                        var dd2 = convert(fechaJS2);
                        ret += "<td>" + dd + "</td>";
                        ret += "<td>" + dd2 + "</td>";
                    }
                }
                ret += "</table>"

                row.child(ret).show();
                tr.addClass('shown');

                return ret;
            },
            error: function (e, ew) {
                alert(e);
            }
        });
    }
</script>

<style>
    .dataTables_length {
        display: none;
    }

    .dataTables_filter {
        display: none;
    }

    .dataTables_scrollHeadInner, .mdl-data-table {
        width: 100%;
    }
</style>



